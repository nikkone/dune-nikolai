############################################################################
# Copyright 2013-2019 Norwegian University of Science and Technology (NTNU)#
# Centre for Autonomous Marine Operations and Systems (AMOS)               #
# Department of Engineering Cybernetics (ITK)                              #
############################################################################
# This file is part of DUNE: Unified Navigation Environment.               #
#                                                                          #
# Commercial Licence Usage                                                 #
# Licencees holding valid commercial DUNE licences may use this file in    #
# accordance with the commercial licence agreement provided with the       #
# Software or, alternatively, in accordance with the terms contained in a  #
# written agreement between you and Faculdade de Engenharia da             #
# Universidade do Porto. For licensing terms, conditions, and further      #
# information contact lsts@fe.up.pt.                                       #
#                                                                          #
# Modified European Union Public Licence - EUPL v.1.1 Usage                #
# Alternatively, this file may be used under the terms of the Modified     #
# EUPL, Version 1.1 only (the "Licence"), appearing in the file LICENCE.md #
# included in the packaging of this file. You may not use this work        #
# except in compliance with the Licence. Unless required by applicable     #
# law or agreed to in writing, software distributed under the Licence is   #
# distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF     #
# ANY KIND, either express or implied. See the Licence for the specific    #
# language governing permissions and limitations at                        #
# https://github.com/LSTS/dune/blob/master/LICENCE.md and                  #
# http://ec.europa.eu/idabc/eupl.html.                                     #
############################################################################
# Author: Joao Fortuna                                                     #
############################################################################
# Otter USV configuration file.                                            #
############################################################################

[Require ../common/imc-addresses.ini]
[Require ../common/transports.ini]
[Require ../common/transports.ini]
[Require ../common/maneuvers.ini]

############################################################################
# General Parameters.                                                      #
############################################################################
[IMC Addresses]
ntnu-otter-01                           = 0x2c60

[General]
Vehicle                                 = ntnu-otter-01
Vehicle Type                            = asv
Speed Conversion -- Actuation           = 0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0
Speed Conversion -- RPM                 = 0.0, 120, 245, 360, 490, 615, 725, 845, 980, 980, 980
Speed Conversion -- MPS                 = 0.0, 1.0, 1.3
Absolute Maximum Depth                  = 0
Time Of Arrival Factor                  = 5.0

[Transports.Announce]
Enabled                                 = Always
Entity Label                            = Announce
Announcement Periodicity                = 10
Enable Loopback                         = 1
Enable Multicast                        = 1
Enable Broadcast                        = 1
Multicast Address                       = 224.0.75.69
Ports                                   = 30100, 30101, 30102, 30103, 30104
System Type                             = USV

[Transports.Discovery]
Enabled                                 = Always
Entity Label                            = Discovery
Multicast Address                       = 224.0.75.69
Ports                                   = 30100, 30101, 30102, 30103, 30104

[Transports.Logging]
Flush Interval                          = 0.5

############################################################################
# Navigation.                                                              #
############################################################################

[Navigation.General.GPSNavigation]
Enabled                                 = Always
Entity Label                            = Navigation
Entity Label - GPS                      = GPS
Entity Label - Yaw                      = GPS

############################################################################
# Control.                                                                 #
############################################################################

[Control.ASV.HeadingAndSpeed]
Enabled                                 = Always
Entity Label                            = Heading & Speed Controller
Maximum Thrust Actuation                = 0.8
Maximum Thrust Differential Actuation   = 0.2
Ramp Actuation Limit                    = 0.0
Hardware RPMs Control                   = true
RPMs at Maximum Thrust                  = 980
RPMs PID Gains                          = 0.2e-3, 0.21e-3, 29.0e-6
RPMs Feedforward Gain                   = 0.46e-3
MPS PID Gains                           = 0.0, 25.0, 0.0
MPS Integral Limit                      = 400.0
MPS Feedforward Gain                    = 1000.0
Minimum RPM Limit                       = 98
Maximum RPM Limit                       = 980
Maximum RPM Acceleration                = 80
Yaw PID Gains                           = 1.5, 0.0, 0.0
Maximum Heading Error to Thrust         = 60.0
Entity Label - Port Motor               = Motor 0
Entity Label - Starboard Motor          = Motor 1
Share Saturation                        = true
Log PID Parcels                         = true
Debug Level                             = None

[Control.Path.ILOS]
Enabled                                 = Always
Entity Label                            = Path Control
Debug Level                             = None
Control Frequency                       = 10
Along-track -- Check Period             = 20
Along-track -- Minimum Speed            = 0.05
Along-track -- Minimum Yaw              = 2
Cross-track -- Monitor                  = true
Cross-track -- Nav. Unc. Factor         = 1
Cross-track -- Distance Limit           = 25
Cross-track -- Time Limit               = 20
Position Jump Threshold                 = 10.0
Position Jump Time Factor               = 0.5
ETA Minimum Speed                       = 0.1
New Reference Timeout                   = 5.0
Course Control                          = false
Corridor -- Width                       = 1.5
Corridor -- Entry Angle                 = 15.0
Corridor -- Out Vector Field            = true
Corridor -- Out LOS                     = false
ILOS Lookahead Distance                 = 4.0
ILOS Integrator Gain                    = 0.5
ILOS Integrator Initial Value           = 0.0
Bottom Track -- Enabled                 = false

[Control.ASV.RemoteOperation]
Enabled                                 = Always
Entity Label                            = Remote Control
Execution Frequency                     = 10
Connection Timeout                      = 2.0

############################################################################
# Maneuvers.                                                               #
############################################################################

[Maneuver.FollowReference.AUV]
Enabled                                 = Always
Entity Label                            = Follow Reference Maneuver
Horizontal Tolerance                    = 15.0
Vertical Tolerance                      = 1.0
Loitering Radius                        = 7.5
Default Speed                           = 50
Default Speed Units                     = percent
Default Z                               = 0
Default Z Units                         = DEPTH

[Maneuver.RowsCoverage]
Enabled                                 = Always
Entity Label                            = Rows Coverage Maneuver

############################################################################
# Monitors / Supervisors                                                  #
############################################################################

[Monitors.Clock]
Enabled                                 = Never
Entity Label                            = Clock
GPS Entity Label                        = GPS
Minimum GPS Fixes                       = 30
Maximum Clock Offset                    = 2
Boot Synchronization Timeout            = 60
Hardware Clock Synchronization Command  = hwclock -w

[Monitors.Entities]
Enabled                                 = Always
Entity Label                            = Entity Monitor
Activation Time                         = 0
Deactivation Time                       = 0
Debug Level                             = None
Execution Priority                      = 10
Report Timeout                          = 5
Transition Time Gap                     = 4.0
Maximum Consecutive Transitions         = 3
Default Monitoring                      = Daemon,
#                                          GPS,
                                          Navigation,
                                          Path Control

[Supervisors.Vehicle]
Enabled                                 = Always
Entity Label                            = Vehicle Supervisor
Activation Time                         = 0
Deactivation Time                       = 0
Debug Level                             = None
Execution Priority                      = 10
Execution Frequency                     = 2
Allows External Control                 = false
Maneuver Handling Timeout               = 1.0

[Supervisors.ClockPPS]
Enabled                                 = Hardware
Entity Label                            = Clock
Activation Time                         = 0
Deactivation Time                       = 0
Debug Level                             = None
Execution Priority                      = 10
PPS - Device                            = /dev/pps0
PPS - Propagation Delay                 = 675
PPS - Maximum Offset                    = 50
GPS Entity Label                        = GPS
GPS Offset Count                        = 10
Execute On Synchronization              = hwclock -w

############################################################################
# Hardware.                                                                #
############################################################################

[Actuators.Torqeedo]
Enabled                                 = Hardware
Debug Level                             = Trace
Entity Label                            = Torqeedo
CAN Port - Device                       = can0
Power Channel H_MOT0 - Name             = Aftmotor
Power Channel H_MOT0 - State            = 1
Power Channel H_MOT1 - Name             = Portmotor
Power Channel H_MOT1 - State            = 1

############################################################################
# Simulators.                                                              #
############################################################################

[Require ../common/vsim-models.ini]

# Vehicle simulator.
[Simulators.VSIM]
Enabled                                 = Simulation
Entity Label                            = Simulation Engine
Execution Frequency                     = 25
Stream Speed East                       = 0
Stream Speed North                      = 0

# GPS simulator.
[Simulators.GPS]
Enabled                                 = Simulation
Execution Frequency                     = 1
Entity Label                            = GPS
Number of Satellites                    = 8
HACC                                    = 2
HDOP                                    = 0.9
Activation Depth                        = 0.2
Report Ground Velocity                  = false
Report Yaw                              = false
Initial Position                        = 41.1850, -8.7062

# Port motor.
[Simulators.Motor/Port]
Enabled                                 = Simulation
Entity Label                            = Motor - Port
Execution Frequency                     = 20
Thruster Act to RPM Factor              = 9.55, 2450.40
Thruster Id                             = 0

# Starboard motor.
[Simulators.Motor/Starboard]
Enabled                                 = Simulation
Entity Label                            = Motor - Starboard
Execution Frequency                     = 20
Thruster Act to RPM Factor              = 9.55, 2450.40
Thruster Id                             = 1


[Transports.UDP]
Enabled                                 = Always
Entity Label                            = UDP
Transports                              = Acceleration,
                                          AngularVelocity,
                                          AutopilotMode,
                                          CpuUsage,
                                          Current,
                                          DesiredPath,
                                          DesiredRoll,
                                          DesiredSpeed,
                                          DesiredVerticalRate,
                                          DesiredZ,
                                          EntityList,
                                          EntityParameters,
                                          EntityState,
                                          EstimatedState,
                                          EstimatedStreamVelocity,
                                          EulerAnglesDelta,
                                          FollowRefState,
                                          FuelLevel,
                                          GpsFix,
                                          GpsNavData,
                                          Heartbeat,
                                          IndicatedSpeed,
                                          LeaderState,
                                          LinkLevel,
                                          LogBookControl,
                                          LoggingControl,
                                          MagneticField,
                                          OperationalLimits,
                                          PathControlState,
                                          PlanControl,
                                          PlanControlState,
                                          PlanDB,
                                          PlanGeneration,
                                          PlanSpecification,
                                          PowerChannelControl,
                                          Pressure,
                                          QueryEntityParameters,
                                          RemoteActionsRequest,
                                          Rpm,
                                          RSSI,
                                          SaveEntityParameters,
                                          SetEntityParameters,
                                          SetServoPosition,
                                          SimulatedState,
                                          StorageUsage,
                                          Target,
                                          Temperature,
                                          TrexOperation,
                                          TrueSpeed,
                                          VehicleMedium,
                                          VehicleState,
                                          VelocityDelta,
                                          Voltage
Filtered Entities                       = CpuUsage:Daemon
Local Port                              = 6002
Print Incoming Messages                 = 0
Print Outgoing Messages                 = 0
Rate Limiters                           = CpuUsage:1,
                                          EntityState:1,
                                          EstimatedState:10,
                                          FuelLevel:0.1,
                                          SimulatedState:0.5,
                                          StorageUsage:0.05,
                                          Acceleration:10,
                                          AngularVelocity:10,
                                          MagneticField:10,
                                          Temperature:10,
                                          Pressure:10,
                                          EulerAnglesDelta:10,
                                          VelocityDelta:10

[Transports.Logging]
Enabled                                 = Always
Entity Label                            = Logger
Flush Interval                          = 5
LSF Compression Method                  = gzip
Transports                              = Acceleration,
                                          AngularVelocity,
                                          Announce,
                                          AutopilotMode,
                                          ControlLoops,
                                          CpuUsage,
                                          Current,
                                          DesiredHeading,
                                          DesiredPath,
                                          DesiredRoll,
                                          DesiredSpeed,
                                          DesiredVerticalRate,
                                          DesiredZ,
                                          DevCalibrationControl,
                                          EntityList,
                                          EntityState,
                                          EstimatedState,
                                          EstimatedStreamVelocity,
                                          EulerAnglesDelta,
                                          FollowReference,
                                          FollowRefState,
                                          FuelLevel,
                                          GpsFix,
                                          GpsNavData,
                                          IndicatedSpeed,
                                          LeaderState,
                                          LinkLevel,
                                          LogBookEntry,
                                          MagneticField,
                                          ManeuverControlState,
                                          PathControlState,
                                          PlanControl,
                                          PlanSpecification,
                                          PlanControlState,
                                          PlanDB,
                                          PowerChannelControl,
                                          Pressure,
                                          Reference,
                                          Rpm,
                                          RSSI,
                                          SetControlSurfaceDeflection,
                                          SetThrusterActuation,
                                          SimulatedState,
                                          StopManeuver,
                                          StorageUsage,
                                          Temperature,
                                          TrueSpeed,
                                          TrexObservation,
                                          TrexPlan,
                                          TrexToken,
                                          TrueSpeed,
                                          VehicleCommand,
                                          VehicleMedium,
                                          VehicleState,
                                          VelocityDelta,
                                          Voltage
